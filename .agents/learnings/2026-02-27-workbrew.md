# Learnings — WorkBrew (Cafe & WiFi Finder)

__Date:__ 2026-02-27
__Source:__ Full project retro — scope, development, QA, deployment

---

# Learning: OPST Skill Resolution Pattern

__ID:__ L1
__Category:__ process
__Confidence:__ high

## What We Learned

When the Product Owner invokes a skill by name (e.g., "retro skill", "run the prd skill"), Cap must immediately read `_OPST/assets/SKILLS/<skill-name>/SKILL.md` and execute its workflow directly. The VS Code Skill tool only resolves registered extension skills — OPST custom skills must be read manually from the filesystem.

## Why It Matters

Attempting to use the Skill tool for OPST skills silently fails with "Unknown skill", stalling the workflow and breaking user trust.

## Source

Retro phase invocation failure — user had to correct Cap mid-session.

---

# Learning: LOCAL_LOG.md Phase Gate Discipline

__ID:__ L2
__Category:__ process
__Confidence:__ high

## What We Learned

`LOCAL_LOG.md` must be updated at every phase gate (development, QA, deployment, retro) — not just at kickoff. Phases 1–3 were never logged in WorkBrew despite the GLOBAL_EVOLUTION mandate in section 6.

## Why It Matters

The log is the definitive local memory for the project. Gaps mean handoff context is lost and the retro lacks a paper trail to reference.

## Source

LOCAL_LOG.md had Phase 0 complete and Phases 1–4 marked "(pending)" at retro time.

---

# Learning: Flask Flash Messages Cause False Positives in Redirect Tests

__ID:__ L3
__Category:__ testing
__Confidence:__ high

## What We Learned

When testing a POST → redirect → GET flow with `follow_redirects=True`, Flask flash messages are rendered in the GET response. Asserting `b"CafeName"` will produce a false positive if the name appears in the flash text (e.g., `'"CafeName" has been removed.'`). Always anchor assertions to an HTML element pattern (e.g., `b"CafeName</h3>"`) that cannot appear in a flash banner.

## Why It Matters

The `test_cafe_removed_from_homepage_after_delete` test required three fix cycles because the root cause (flash message content) was not checked first.

## Source

WorkBrew QA — Vera's delete test failure diagnosis.

---

# Learning: Temp-File SQLite Is the Correct Flask+SQLAlchemy Test Fixture

__ID:__ L4
__Category:__ testing
__Confidence:__ high

## What We Learned

Use `tempfile.mkstemp(suffix=".db")` for the test database URI, not `StaticPool` or in-memory SQLite. StaticPool does not provide request-level connection isolation in Flask's test client — requests can see each other's uncommitted state. Temp-file SQLite does.

## Why It Matters

In-memory / StaticPool fixtures can produce false passes where the real app would fail, or false failures where test state bleeds between requests.

## Source

WorkBrew QA fixture stabilization after first test run failure.

---

# Learning: WSGI Bootstrap — db.create_all() Must Be Outside __main__

__ID:__ L5
__Category:__ architecture
__Confidence:__ high

## What We Learned

`db.create_all()` (and any other cold-start bootstrap code) must execute at module import time, not inside `if __name__ == "__main__":`. Gunicorn and other WSGI servers import the app module but never set `__name__ == "__main__"`, so any code gated by that block is silently skipped in production.

## Why It Matters

Without this, tables are never created on first deploy, causing immediate 500 errors that are confusing to diagnose.

## Source

WorkBrew deployment fix — moved `db.create_all()` outside `__main__` before Render deploy.

---

# Learning: PostgreSQL Schema Isolation via search_path

__ID:__ L6
__Category:__ architecture
__Confidence:__ high

## What We Learned

To isolate one app's tables within a named PostgreSQL schema on a shared instance, set `search_path` via `SQLALCHEMY_ENGINE_OPTIONS.connect_args.options` (e.g., `"-csearch_path=workbrew,public"`). This is transparent to all ORM models and queries — no `__table_args__ = {"schema": ...}` changes needed on any model.

## Why It Matters

Per-model schema decorators require touching every model and can break migrations. The `search_path` approach requires only one config change and zero model changes.

## Source

WorkBrew — schema isolation for shared `rudil24_db` Postgres instance.

---

# Learning: Render Free-Tier Seeding via startCommand Chain

__ID:__ L7
__Category:__ devops
__Confidence:__ high

## What We Learned

On Render free tier (no shell access), database seeding can be chained into the start command: `python seed.py && gunicorn app:app`. Add an idempotency guard in the seed script (`if Cafe.query.count(): return`) to skip seeding on subsequent restarts.

## Why It Matters

Free-tier plans don't allow one-off jobs or shell commands from the dashboard. The chain pattern is clean, idempotent, and runs on every cold start with zero manual intervention.

## Source

WorkBrew deployment — discovered shell tab was unavailable on free plan.

---

# Learning: instance/ Must Be in .gitignore from Day One

__ID:__ L8
__Category:__ devops
__Confidence:__ high

## What We Learned

Flask's default SQLite database is written to `instance/cafes.db`. The `instance/` directory must be added to `.gitignore` at project initialization — not discovered after the DB has already been committed and pushed.

## Why It Matters

SQLite DB files are binary, can contain sensitive seed data, and should never be in version control. Removing them after the fact requires `git rm --cached` and a force-push awareness conversation.

## Source

WorkBrew Phase 0 — `instance/cafes.db` was tracked until caught mid-project.

---

# Learning: Excalidraw/Figma/Claude Artifacts Over ASCII Mockups

__ID:__ L9
__Category:__ design
__Confidence:__ high

## What We Learned

ASCII wireframes are too low-fidelity and don't translate well to implementation. Prefer Excalidraw (via skill), Figma, or Claude Artifacts for UI mockups before writing HTML/CSS. The one-shot html/css approach worked on WorkBrew but is not a reliable process — it succeeded by luck, not by design.

## Why It Matters

A visual mockup with tool-supported fidelity (Excalidraw at minimum) gives the Product Owner a meaningful approval gate before CSS is written, reducing rework risk.

## Source

Product Owner feedback in retro: "Not sure we'll get that lucky next time."

---

# Learning: Teamlead Wakeup Workflow Needs Consolidation

__ID:__ L10
__Category:__ process
__Confidence:__ medium

## What We Learned

The OPST teamlead wakeup flow has been written in multiple variations, creating confusion about which version is authoritative. The key anchor should be a clean CLAUDE.md symlink from `_OPST` that gives Cap a single entry point with links to everything else it needs.

## Why It Matters

If Cap can't reliably orient itself at session start, it wastes time and potentially operates on stale or incorrect context — as seen when the retro skill wasn't found via the expected path.

## Source

Product Owner feedback in retro: "we've written that a few ways (probably too many)."
